# Nettoyage du code - Migration React Query

**Date:** 2025-10-31

---

## ğŸ“ RÃ©sumÃ©

AprÃ¨s la migration complÃ¨te vers React Query, nous avons nettoyÃ© le code pour supprimer les mÃ©thodes obsolÃ¨tes et simplifier l'architecture.

---

## ğŸ§¹ Changements effectuÃ©s

### 1. Simplification du store Zustand (`src/store/useAppStore.ts`)

**Avant:** 492 lignes avec toutes les mÃ©thodes CRUD pour chaque entitÃ©

**AprÃ¨s:** 98 lignes avec uniquement :
- Ã‰tat utilisateur (gÃ©rÃ© par Supabase Auth)
- Ã‰tat UI (notifications, loading, error)

**MÃ©thodes supprimÃ©es:**
- âŒ `addAmbition`, `updateAmbition`, `deleteAmbition`
- âŒ `addKeyResult`, `updateKeyResult`, `deleteKeyResult`
- âŒ `addOKR`, `updateOKR`, `deleteOKR`
- âŒ `addAction`, `updateAction`, `deleteAction`
- âŒ `addQuarterlyObjective`, `updateQuarterlyObjective`, `deleteQuarterlyObjective`
- âŒ `addQuarterlyKeyResult`, `updateQuarterlyKeyResult`, `deleteQuarterlyKeyResult`
- âŒ `moveAction`, `reorderActionsInStatus`
- âŒ `addProgress`
- âŒ `loadData`, `refreshMetrics`

**MÃ©thodes conservÃ©es:**
- âœ… `setUser`, `updateCompanyProfile`, `logout`
- âœ… `setLoading`, `setError`
- âœ… `addNotification`, `removeNotification`, `clearNotifications`

**DonnÃ©es supprimÃ©es du store:**
- âŒ `ambitions`, `keyResults`, `okrs`, `actions`
- âŒ `quarterlyObjectives`, `quarterlyKeyResults`, `progress`
- âŒ `metrics`, `hasHydrated`

**DonnÃ©es conservÃ©es:**
- âœ… `user`, `isAuthenticated`
- âœ… `isLoading`, `error`, `notifications`

---

### 2. Migration de la page Actions (`src/pages/actions.tsx`)

**Changements:**

1. **Imports ajoutÃ©s:**
```typescript
import { useAmbitions } from '@/hooks/useAmbitions';
import { useQuarterlyObjectives } from '@/hooks/useQuarterlyObjectives';
import { useQuarterlyKeyResults } from '@/hooks/useQuarterlyKeyResults';
import { useActions, useCreateAction, useUpdateAction, useDeleteAction } from '@/hooks/useActions';
```

2. **Remplacement de `useAppStore()` par React Query:**
```typescript
// Avant
const {
  actions,
  ambitions,
  quarterlyObjectives,
  quarterlyKeyResults,
  addAction,
  updateAction,
  deleteAction,
} = useAppStore();

// AprÃ¨s
const { user } = useAppStore();

const { data: ambitions = [] } = useAmbitions(user?.id);
const { data: quarterlyObjectives = [] } = useQuarterlyObjectives(user?.id);
const { data: quarterlyKeyResults = [] } = useQuarterlyKeyResults(user?.id);
const { data: actions = [] } = useActions(user?.id);

const createAction = useCreateAction();
const updateActionMutation = useUpdateAction();
const deleteActionMutation = useDeleteAction();
```

3. **Mise Ã  jour des handlers:**
- `handleActionSubmit` â†’ utilise `createAction.mutateAsync()` et `updateActionMutation.mutateAsync()`
- `handleActionMove` â†’ utilise `updateActionMutation.mutateAsync()`
- `onActionDelete` â†’ utilise `deleteActionMutation.mutateAsync()`

---

## ğŸ“Š Pages migrÃ©es

Toutes les pages principales utilisent maintenant React Query :

- âœ… **Dashboard** (`src/pages/dashboard.tsx`)
- âœ… **Management** (`src/pages/management.tsx`)
- âœ… **Canvas** (`src/pages/canvas.tsx`)
  - âœ… AmbitionsAndKeyResultsStep
  - âœ… QuarterlyObjectivesStep
  - âœ… ActionsStep
- âœ… **Actions** (`src/pages/actions.tsx`)

---

## ğŸ¯ Architecture finale

### **Gestion des donnÃ©es**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Supabase PostgreSQL           â”‚
â”‚         (Source de vÃ©ritÃ©)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Services DB (src/services/db/)     â”‚
â”‚  - ambitions.ts                         â”‚
â”‚  - keyResults.ts                        â”‚
â”‚  - quarterlyObjectives.ts               â”‚
â”‚  - quarterlyKeyResults.ts               â”‚
â”‚  - actions.ts                           â”‚
â”‚  - progress.ts                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      React Query Hooks (src/hooks/)     â”‚
â”‚  - useAmbitions.ts                      â”‚
â”‚  - useKeyResults.ts                     â”‚
â”‚  - useQuarterlyObjectives.ts            â”‚
â”‚  - useQuarterlyKeyResults.ts            â”‚
â”‚  - useActions.ts                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Composants React                â”‚
â”‚  - Dashboard                            â”‚
â”‚  - Management                           â”‚
â”‚  - Canvas                               â”‚
â”‚  - Actions                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **Gestion de l'Ã©tat UI**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Zustand Store (src/store/)         â”‚
â”‚                                         â”‚
â”‚  useAppStore:                           â”‚
â”‚  - user, isAuthenticated                â”‚
â”‚  - isLoading, error                     â”‚
â”‚  - notifications                        â”‚
â”‚                                         â”‚
â”‚  useCanvasStore:                        â”‚
â”‚  - currentStep, steps                   â”‚
â”‚  - workflow data (temporaire)           â”‚
â”‚  - AI validations                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… Avantages de la nouvelle architecture

1. **SÃ©paration des responsabilitÃ©s**
   - Zustand = Ã‰tat UI uniquement
   - React Query = DonnÃ©es serveur

2. **Cache automatique**
   - Pas besoin de gÃ©rer manuellement le cache
   - Invalidation automatique aprÃ¨s mutations

3. **Code plus simple**
   - Moins de code boilerplate
   - Moins de bugs potentiels

4. **Performance**
   - Chargement optimisÃ© des donnÃ©es
   - Pas de re-renders inutiles

5. **MaintenabilitÃ©**
   - Code plus facile Ã  comprendre
   - Moins de duplication

---

## ğŸ§ª Tests Ã  effectuer

- âœ… Dashboard affiche les donnÃ©es
- âœ… Management permet de crÃ©er/modifier/supprimer
- âœ… Canvas fonctionne de bout en bout
- â³ Actions affiche les donnÃ©es (en cours de test)

---

## ğŸ“ Prochaines Ã©tapes

1. VÃ©rifier que la page Actions fonctionne correctement
2. Tester tous les workflows de bout en bout
3. Supprimer les imports inutilisÃ©s
4. Mettre Ã  jour la documentation utilisateur si nÃ©cessaire

