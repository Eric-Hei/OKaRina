# Nettoyage du code - Migration React Query

**Date:** 2025-10-31

---

## 📝 Résumé

Après la migration complète vers React Query, nous avons nettoyé le code pour supprimer les méthodes obsolètes et simplifier l'architecture.

---

## 🧹 Changements effectués

### 1. Simplification du store Zustand (`src/store/useAppStore.ts`)

**Avant:** 492 lignes avec toutes les méthodes CRUD pour chaque entité

**Après:** 98 lignes avec uniquement :
- État utilisateur (géré par Supabase Auth)
- État UI (notifications, loading, error)

**Méthodes supprimées:**
- ❌ `addAmbition`, `updateAmbition`, `deleteAmbition`
- ❌ `addKeyResult`, `updateKeyResult`, `deleteKeyResult`
- ❌ `addOKR`, `updateOKR`, `deleteOKR`
- ❌ `addAction`, `updateAction`, `deleteAction`
- ❌ `addQuarterlyObjective`, `updateQuarterlyObjective`, `deleteQuarterlyObjective`
- ❌ `addQuarterlyKeyResult`, `updateQuarterlyKeyResult`, `deleteQuarterlyKeyResult`
- ❌ `moveAction`, `reorderActionsInStatus`
- ❌ `addProgress`
- ❌ `loadData`, `refreshMetrics`

**Méthodes conservées:**
- ✅ `setUser`, `updateCompanyProfile`, `logout`
- ✅ `setLoading`, `setError`
- ✅ `addNotification`, `removeNotification`, `clearNotifications`

**Données supprimées du store:**
- ❌ `ambitions`, `keyResults`, `okrs`, `actions`
- ❌ `quarterlyObjectives`, `quarterlyKeyResults`, `progress`
- ❌ `metrics`, `hasHydrated`

**Données conservées:**
- ✅ `user`, `isAuthenticated`
- ✅ `isLoading`, `error`, `notifications`

---

### 2. Migration de la page Actions (`src/pages/actions.tsx`)

**Changements:**

1. **Imports ajoutés:**
```typescript
import { useAmbitions } from '@/hooks/useAmbitions';
import { useQuarterlyObjectives } from '@/hooks/useQuarterlyObjectives';
import { useQuarterlyKeyResults } from '@/hooks/useQuarterlyKeyResults';
import { useActions, useCreateAction, useUpdateAction, useDeleteAction } from '@/hooks/useActions';
```

2. **Remplacement de `useAppStore()` par React Query:**
```typescript
// Avant
const {
  actions,
  ambitions,
  quarterlyObjectives,
  quarterlyKeyResults,
  addAction,
  updateAction,
  deleteAction,
} = useAppStore();

// Après
const { user } = useAppStore();

const { data: ambitions = [] } = useAmbitions(user?.id);
const { data: quarterlyObjectives = [] } = useQuarterlyObjectives(user?.id);
const { data: quarterlyKeyResults = [] } = useQuarterlyKeyResults(user?.id);
const { data: actions = [] } = useActions(user?.id);

const createAction = useCreateAction();
const updateActionMutation = useUpdateAction();
const deleteActionMutation = useDeleteAction();
```

3. **Mise à jour des handlers:**
- `handleActionSubmit` → utilise `createAction.mutateAsync()` et `updateActionMutation.mutateAsync()`
- `handleActionMove` → utilise `updateActionMutation.mutateAsync()`
- `onActionDelete` → utilise `deleteActionMutation.mutateAsync()`

---

## 📊 Pages migrées

Toutes les pages principales utilisent maintenant React Query :

- ✅ **Dashboard** (`src/pages/dashboard.tsx`)
- ✅ **Management** (`src/pages/management.tsx`)
- ✅ **Canvas** (`src/pages/canvas.tsx`)
  - ✅ AmbitionsAndKeyResultsStep
  - ✅ QuarterlyObjectivesStep
  - ✅ ActionsStep
- ✅ **Actions** (`src/pages/actions.tsx`)

---

## 🎯 Architecture finale

### **Gestion des données**

```
┌─────────────────────────────────────────┐
│           Supabase PostgreSQL           │
│         (Source de vérité)              │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│      Services DB (src/services/db/)     │
│  - ambitions.ts                         │
│  - keyResults.ts                        │
│  - quarterlyObjectives.ts               │
│  - quarterlyKeyResults.ts               │
│  - actions.ts                           │
│  - progress.ts                          │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│      React Query Hooks (src/hooks/)     │
│  - useAmbitions.ts                      │
│  - useKeyResults.ts                     │
│  - useQuarterlyObjectives.ts            │
│  - useQuarterlyKeyResults.ts            │
│  - useActions.ts                        │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│         Composants React                │
│  - Dashboard                            │
│  - Management                           │
│  - Canvas                               │
│  - Actions                              │
└─────────────────────────────────────────┘
```

### **Gestion de l'état UI**

```
┌─────────────────────────────────────────┐
│      Zustand Store (src/store/)         │
│                                         │
│  useAppStore:                           │
│  - user, isAuthenticated                │
│  - isLoading, error                     │
│  - notifications                        │
│                                         │
│  useCanvasStore:                        │
│  - currentStep, steps                   │
│  - workflow data (temporaire)           │
│  - AI validations                       │
└─────────────────────────────────────────┘
```

---

## ✅ Avantages de la nouvelle architecture

1. **Séparation des responsabilités**
   - Zustand = État UI uniquement
   - React Query = Données serveur

2. **Cache automatique**
   - Pas besoin de gérer manuellement le cache
   - Invalidation automatique après mutations

3. **Code plus simple**
   - Moins de code boilerplate
   - Moins de bugs potentiels

4. **Performance**
   - Chargement optimisé des données
   - Pas de re-renders inutiles

5. **Maintenabilité**
   - Code plus facile à comprendre
   - Moins de duplication

---

## 🧪 Tests à effectuer

- ✅ Dashboard affiche les données
- ✅ Management permet de créer/modifier/supprimer
- ✅ Canvas fonctionne de bout en bout
- ⏳ Actions affiche les données (en cours de test)

---

## 📝 Prochaines étapes

1. Vérifier que la page Actions fonctionne correctement
2. Tester tous les workflows de bout en bout
3. Supprimer les imports inutilisés
4. Mettre à jour la documentation utilisateur si nécessaire

