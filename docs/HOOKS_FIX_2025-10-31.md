# Correction des hooks React Query - 31 Octobre 2025

## 🐛 Problème rencontré

Les hooks React Query utilisaient des méthodes qui n'existaient pas dans les services Supabase :
- `AmbitionsService.getByUserId()` ❌ → `AmbitionsService.getAll()` ✅
- `QuarterlyObjectivesService.getByUserId()` ❌ → `QuarterlyObjectivesService.getAll()` ✅
- `QuarterlyKeyResultsService.getByUserId()` ❌ → `QuarterlyKeyResultsService.getByObjectiveId()` ✅
- `ActionsService.getByUserId()` ❌ → `ActionsService.getAll()` ✅

---

## ✅ Corrections appliquées

### 1. `src/hooks/useAmbitions.ts`

**Avant :**
```typescript
export function useAmbitions(userId: string | undefined) {
  return useQuery({
    queryKey: ['ambitions', userId],
    queryFn: () => AmbitionsService.getByUserId(userId!),
    enabled: !!userId,
  });
}

export function useAmbition(id: string | undefined) {
  return useQuery({
    queryKey: ['ambitions', id],
    queryFn: () => AmbitionsService.getById(id!),
    enabled: !!id,
  });
}
```

**Après :**
```typescript
export function useAmbitions(userId: string | undefined, year?: number) {
  return useQuery({
    queryKey: ['ambitions', userId, year],
    queryFn: () => AmbitionsService.getAll(userId!, year),
    enabled: !!userId,
  });
}

export function useAmbition(id: string | undefined, userId: string | undefined) {
  return useQuery({
    queryKey: ['ambitions', id],
    queryFn: () => AmbitionsService.getById(id!, userId!),
    enabled: !!id && !!userId,
  });
}
```

**Changements :**
- ✅ `getByUserId()` → `getAll(userId, year?)`
- ✅ Ajout du paramètre `year` optionnel
- ✅ `getById(id)` → `getById(id, userId)` (nécessite userId pour RLS)

---

### 2. `src/hooks/useQuarterlyObjectives.ts`

**Avant :**
```typescript
export function useQuarterlyObjectives(userId: string | undefined) {
  return useQuery({
    queryKey: ['quarterlyObjectives', userId],
    queryFn: () => QuarterlyObjectivesService.getByUserId(userId!),
    enabled: !!userId,
  });
}

export function useQuarterlyObjectivesByAmbition(ambitionId: string | undefined) {
  return useQuery({
    queryKey: ['quarterlyObjectives', 'ambition', ambitionId],
    queryFn: () => QuarterlyObjectivesService.getByAmbitionId(ambitionId!),
    enabled: !!ambitionId,
  });
}

export function useQuarterlyObjective(id: string | undefined) {
  return useQuery({
    queryKey: ['quarterlyObjectives', id],
    queryFn: () => QuarterlyObjectivesService.getById(id!),
    enabled: !!id,
  });
}
```

**Après :**
```typescript
export function useQuarterlyObjectives(userId: string | undefined, quarter?: Quarter, year?: number) {
  return useQuery({
    queryKey: ['quarterlyObjectives', userId, quarter, year],
    queryFn: () => QuarterlyObjectivesService.getAll(userId!, quarter, year),
    enabled: !!userId,
  });
}

export function useQuarterlyObjectivesByAmbition(ambitionId: string | undefined, userId: string | undefined) {
  return useQuery({
    queryKey: ['quarterlyObjectives', 'ambition', ambitionId],
    queryFn: () => QuarterlyObjectivesService.getByAmbitionId(ambitionId!, userId!),
    enabled: !!ambitionId && !!userId,
  });
}

export function useQuarterlyObjective(id: string | undefined, userId: string | undefined) {
  return useQuery({
    queryKey: ['quarterlyObjectives', id],
    queryFn: () => QuarterlyObjectivesService.getById(id!, userId!),
    enabled: !!id && !!userId,
  });
}
```

**Changements :**
- ✅ `getByUserId()` → `getAll(userId, quarter?, year?)`
- ✅ Ajout des paramètres `quarter` et `year` optionnels
- ✅ `getByAmbitionId(ambitionId)` → `getByAmbitionId(ambitionId, userId)`
- ✅ `getById(id)` → `getById(id, userId)`
- ❌ Suppression de `useQuarterlyObjectivesByQuarter` (redondant avec `useQuarterlyObjectives`)

---

### 3. `src/hooks/useQuarterlyKeyResults.ts`

**Avant :**
```typescript
export function useQuarterlyKeyResults(userId: string | undefined) {
  return useQuery({
    queryKey: ['quarterlyKeyResults', userId],
    queryFn: () => QuarterlyKeyResultsService.getByUserId(userId!),
    enabled: !!userId,
  });
}

export function useQuarterlyKeyResultsByObjective(objectiveId: string | undefined) {
  return useQuery({
    queryKey: ['quarterlyKeyResults', 'objective', objectiveId],
    queryFn: () => QuarterlyKeyResultsService.getByObjectiveId(objectiveId!),
    enabled: !!objectiveId,
  });
}
```

**Après :**
```typescript
export function useQuarterlyKeyResults(objectiveId: string | undefined) {
  return useQuery({
    queryKey: ['quarterlyKeyResults', 'objective', objectiveId],
    queryFn: () => QuarterlyKeyResultsService.getByObjectiveId(objectiveId!),
    enabled: !!objectiveId,
  });
}
```

**Changements :**
- ❌ Suppression de `useQuarterlyKeyResults(userId)` (pas de méthode `getByUserId` dans le service)
- ✅ Renommage de `useQuarterlyKeyResultsByObjective` → `useQuarterlyKeyResults`
- ✅ Les KR sont toujours liés à un objectif, donc le hook principal prend `objectiveId`

---

### 4. `src/hooks/useActions.ts`

**Avant :**
```typescript
export function useActions(userId: string | undefined) {
  return useQuery({
    queryKey: ['actions', userId],
    queryFn: () => ActionsService.getByUserId(userId!),
    enabled: !!userId,
  });
}

export function useActionsByObjective(objectiveId: string | undefined) {
  return useQuery({
    queryKey: ['actions', 'objective', objectiveId],
    queryFn: () => ActionsService.getByObjectiveId(objectiveId!),
    enabled: !!objectiveId,
  });
}

export function useAction(id: string | undefined) {
  return useQuery({
    queryKey: ['actions', id],
    queryFn: () => ActionsService.getById(id!),
    enabled: !!id,
  });
}
```

**Après :**
```typescript
export function useActions(userId: string | undefined, status?: ActionStatus) {
  return useQuery({
    queryKey: ['actions', userId, status],
    queryFn: () => ActionsService.getAll(userId!, status),
    enabled: !!userId,
  });
}

export function useActionsByKeyResult(keyResultId: string | undefined, userId: string | undefined) {
  return useQuery({
    queryKey: ['actions', 'keyResult', keyResultId],
    queryFn: () => ActionsService.getByKeyResultId(keyResultId!, userId!),
    enabled: !!keyResultId && !!userId,
  });
}

export function useActionsByStatus(userId: string | undefined) {
  return useQuery({
    queryKey: ['actions', 'status', userId],
    queryFn: () => ActionsService.getByStatus(userId!),
    enabled: !!userId,
  });
}

export function useAction(id: string | undefined, userId: string | undefined) {
  return useQuery({
    queryKey: ['actions', id],
    queryFn: () => ActionsService.getById(id!, userId!),
    enabled: !!id && !!userId,
  });
}
```

**Changements :**
- ✅ `getByUserId()` → `getAll(userId, status?)`
- ✅ Ajout du paramètre `status` optionnel
- ✅ Renommage de `useActionsByObjective` → `useActionsByKeyResult` (les actions sont liées aux KR, pas aux objectifs)
- ✅ `getByObjectiveId()` → `getByKeyResultId(keyResultId, userId)`
- ✅ Ajout de `useActionsByStatus()` pour le Kanban
- ✅ `getById(id)` → `getById(id, userId)`

---

## 📊 Résumé

### Hooks modifiés : 4
- ✅ `src/hooks/useAmbitions.ts`
- ✅ `src/hooks/useQuarterlyObjectives.ts`
- ✅ `src/hooks/useQuarterlyKeyResults.ts`
- ✅ `src/hooks/useActions.ts`

### Méthodes corrigées
- ✅ `getByUserId()` → `getAll()` (4 hooks)
- ✅ Ajout du paramètre `userId` pour les méthodes `getById()` (RLS)
- ✅ Ajout de paramètres optionnels (`year`, `quarter`, `status`)

---

## 🧪 Prochaines étapes

1. **Tester `/test-ui`** - Valider que tous les hooks fonctionnent correctement
2. **Migrer les composants UI** - Utiliser les hooks dans les pages principales
3. **Tester l'application complète** - Vérifier que tout fonctionne end-to-end

---

**Date :** 2025-10-31  
**Version :** OsKaR v2.0 (Supabase + React Query)  
**Auteur :** Augment Agent

