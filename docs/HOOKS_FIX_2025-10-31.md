# Correction des hooks React Query - 31 Octobre 2025

## ðŸ› ProblÃ¨me rencontrÃ©

Les hooks React Query utilisaient des mÃ©thodes qui n'existaient pas dans les services Supabase :
- `AmbitionsService.getByUserId()` âŒ â†’ `AmbitionsService.getAll()` âœ…
- `QuarterlyObjectivesService.getByUserId()` âŒ â†’ `QuarterlyObjectivesService.getAll()` âœ…
- `QuarterlyKeyResultsService.getByUserId()` âŒ â†’ `QuarterlyKeyResultsService.getByObjectiveId()` âœ…
- `ActionsService.getByUserId()` âŒ â†’ `ActionsService.getAll()` âœ…

---

## âœ… Corrections appliquÃ©es

### 1. `src/hooks/useAmbitions.ts`

**Avant :**
```typescript
export function useAmbitions(userId: string | undefined) {
  return useQuery({
    queryKey: ['ambitions', userId],
    queryFn: () => AmbitionsService.getByUserId(userId!),
    enabled: !!userId,
  });
}

export function useAmbition(id: string | undefined) {
  return useQuery({
    queryKey: ['ambitions', id],
    queryFn: () => AmbitionsService.getById(id!),
    enabled: !!id,
  });
}
```

**AprÃ¨s :**
```typescript
export function useAmbitions(userId: string | undefined, year?: number) {
  return useQuery({
    queryKey: ['ambitions', userId, year],
    queryFn: () => AmbitionsService.getAll(userId!, year),
    enabled: !!userId,
  });
}

export function useAmbition(id: string | undefined, userId: string | undefined) {
  return useQuery({
    queryKey: ['ambitions', id],
    queryFn: () => AmbitionsService.getById(id!, userId!),
    enabled: !!id && !!userId,
  });
}
```

**Changements :**
- âœ… `getByUserId()` â†’ `getAll(userId, year?)`
- âœ… Ajout du paramÃ¨tre `year` optionnel
- âœ… `getById(id)` â†’ `getById(id, userId)` (nÃ©cessite userId pour RLS)

---

### 2. `src/hooks/useQuarterlyObjectives.ts`

**Avant :**
```typescript
export function useQuarterlyObjectives(userId: string | undefined) {
  return useQuery({
    queryKey: ['quarterlyObjectives', userId],
    queryFn: () => QuarterlyObjectivesService.getByUserId(userId!),
    enabled: !!userId,
  });
}

export function useQuarterlyObjectivesByAmbition(ambitionId: string | undefined) {
  return useQuery({
    queryKey: ['quarterlyObjectives', 'ambition', ambitionId],
    queryFn: () => QuarterlyObjectivesService.getByAmbitionId(ambitionId!),
    enabled: !!ambitionId,
  });
}

export function useQuarterlyObjective(id: string | undefined) {
  return useQuery({
    queryKey: ['quarterlyObjectives', id],
    queryFn: () => QuarterlyObjectivesService.getById(id!),
    enabled: !!id,
  });
}
```

**AprÃ¨s :**
```typescript
export function useQuarterlyObjectives(userId: string | undefined, quarter?: Quarter, year?: number) {
  return useQuery({
    queryKey: ['quarterlyObjectives', userId, quarter, year],
    queryFn: () => QuarterlyObjectivesService.getAll(userId!, quarter, year),
    enabled: !!userId,
  });
}

export function useQuarterlyObjectivesByAmbition(ambitionId: string | undefined, userId: string | undefined) {
  return useQuery({
    queryKey: ['quarterlyObjectives', 'ambition', ambitionId],
    queryFn: () => QuarterlyObjectivesService.getByAmbitionId(ambitionId!, userId!),
    enabled: !!ambitionId && !!userId,
  });
}

export function useQuarterlyObjective(id: string | undefined, userId: string | undefined) {
  return useQuery({
    queryKey: ['quarterlyObjectives', id],
    queryFn: () => QuarterlyObjectivesService.getById(id!, userId!),
    enabled: !!id && !!userId,
  });
}
```

**Changements :**
- âœ… `getByUserId()` â†’ `getAll(userId, quarter?, year?)`
- âœ… Ajout des paramÃ¨tres `quarter` et `year` optionnels
- âœ… `getByAmbitionId(ambitionId)` â†’ `getByAmbitionId(ambitionId, userId)`
- âœ… `getById(id)` â†’ `getById(id, userId)`
- âŒ Suppression de `useQuarterlyObjectivesByQuarter` (redondant avec `useQuarterlyObjectives`)

---

### 3. `src/hooks/useQuarterlyKeyResults.ts`

**Avant :**
```typescript
export function useQuarterlyKeyResults(userId: string | undefined) {
  return useQuery({
    queryKey: ['quarterlyKeyResults', userId],
    queryFn: () => QuarterlyKeyResultsService.getByUserId(userId!),
    enabled: !!userId,
  });
}

export function useQuarterlyKeyResultsByObjective(objectiveId: string | undefined) {
  return useQuery({
    queryKey: ['quarterlyKeyResults', 'objective', objectiveId],
    queryFn: () => QuarterlyKeyResultsService.getByObjectiveId(objectiveId!),
    enabled: !!objectiveId,
  });
}
```

**AprÃ¨s :**
```typescript
export function useQuarterlyKeyResults(objectiveId: string | undefined) {
  return useQuery({
    queryKey: ['quarterlyKeyResults', 'objective', objectiveId],
    queryFn: () => QuarterlyKeyResultsService.getByObjectiveId(objectiveId!),
    enabled: !!objectiveId,
  });
}
```

**Changements :**
- âŒ Suppression de `useQuarterlyKeyResults(userId)` (pas de mÃ©thode `getByUserId` dans le service)
- âœ… Renommage de `useQuarterlyKeyResultsByObjective` â†’ `useQuarterlyKeyResults`
- âœ… Les KR sont toujours liÃ©s Ã  un objectif, donc le hook principal prend `objectiveId`

---

### 4. `src/hooks/useActions.ts`

**Avant :**
```typescript
export function useActions(userId: string | undefined) {
  return useQuery({
    queryKey: ['actions', userId],
    queryFn: () => ActionsService.getByUserId(userId!),
    enabled: !!userId,
  });
}

export function useActionsByObjective(objectiveId: string | undefined) {
  return useQuery({
    queryKey: ['actions', 'objective', objectiveId],
    queryFn: () => ActionsService.getByObjectiveId(objectiveId!),
    enabled: !!objectiveId,
  });
}

export function useAction(id: string | undefined) {
  return useQuery({
    queryKey: ['actions', id],
    queryFn: () => ActionsService.getById(id!),
    enabled: !!id,
  });
}
```

**AprÃ¨s :**
```typescript
export function useActions(userId: string | undefined, status?: ActionStatus) {
  return useQuery({
    queryKey: ['actions', userId, status],
    queryFn: () => ActionsService.getAll(userId!, status),
    enabled: !!userId,
  });
}

export function useActionsByKeyResult(keyResultId: string | undefined, userId: string | undefined) {
  return useQuery({
    queryKey: ['actions', 'keyResult', keyResultId],
    queryFn: () => ActionsService.getByKeyResultId(keyResultId!, userId!),
    enabled: !!keyResultId && !!userId,
  });
}

export function useActionsByStatus(userId: string | undefined) {
  return useQuery({
    queryKey: ['actions', 'status', userId],
    queryFn: () => ActionsService.getByStatus(userId!),
    enabled: !!userId,
  });
}

export function useAction(id: string | undefined, userId: string | undefined) {
  return useQuery({
    queryKey: ['actions', id],
    queryFn: () => ActionsService.getById(id!, userId!),
    enabled: !!id && !!userId,
  });
}
```

**Changements :**
- âœ… `getByUserId()` â†’ `getAll(userId, status?)`
- âœ… Ajout du paramÃ¨tre `status` optionnel
- âœ… Renommage de `useActionsByObjective` â†’ `useActionsByKeyResult` (les actions sont liÃ©es aux KR, pas aux objectifs)
- âœ… `getByObjectiveId()` â†’ `getByKeyResultId(keyResultId, userId)`
- âœ… Ajout de `useActionsByStatus()` pour le Kanban
- âœ… `getById(id)` â†’ `getById(id, userId)`

---

## ðŸ“Š RÃ©sumÃ©

### Hooks modifiÃ©s : 4
- âœ… `src/hooks/useAmbitions.ts`
- âœ… `src/hooks/useQuarterlyObjectives.ts`
- âœ… `src/hooks/useQuarterlyKeyResults.ts`
- âœ… `src/hooks/useActions.ts`

### MÃ©thodes corrigÃ©es
- âœ… `getByUserId()` â†’ `getAll()` (4 hooks)
- âœ… Ajout du paramÃ¨tre `userId` pour les mÃ©thodes `getById()` (RLS)
- âœ… Ajout de paramÃ¨tres optionnels (`year`, `quarter`, `status`)

---

## ðŸ§ª Prochaines Ã©tapes

1. **Tester `/test-ui`** - Valider que tous les hooks fonctionnent correctement
2. **Migrer les composants UI** - Utiliser les hooks dans les pages principales
3. **Tester l'application complÃ¨te** - VÃ©rifier que tout fonctionne end-to-end

---

**Date :** 2025-10-31  
**Version :** OsKaR v2.0 (Supabase + React Query)  
**Auteur :** Augment Agent

