# Correction des erreurs de build - 31 Octobre 2025

## 🐛 Problème rencontré

Après la suppression de `src/services/storage.ts`, plusieurs fichiers avaient encore des imports vers ce fichier supprimé, causant des erreurs de build :

```
Module not found: Can't resolve './storage'
```

---

## ✅ Solution appliquée

Pour chaque fichier qui utilisait `storageService`, nous avons :

1. **Commenté l'import** de `storageService`
2. **Créé un stub temporaire** qui retourne des données vides
3. **Ajouté un commentaire TODO** pour indiquer que le fichier doit être migré vers Supabase

---

## 📝 Fichiers modifiés

### 1. `src/services/analytics.ts`
**Problème :** Utilisait `storageService` pour récupérer les données

**Solution :** Modifié toutes les méthodes pour accepter les données en paramètres au lieu de les récupérer via `storageService`

**Changements :**
- `getDashboardMetrics()` → `getDashboardMetrics(ambitions, okrs, actions, quarterlyObjectives, quarterlyKeyResults)`
- `calculateOverallProgress()` → `calculateOverallProgress(quarterlyKeyResults)`
- `calculateAmbitionProgress(ambitionId)` → `calculateAmbitionProgress(ambitionId, quarterlyObjectives, quarterlyKeyResults)`
- `calculateMonthlyProgress()` → `calculateMonthlyProgress(quarterlyKeyResults)`
- `getUpcomingDeadlinesCount()` → `getUpcomingDeadlinesCount(actions)`
- `getProgressByCategory()` → `getProgressByCategory(ambitions, quarterlyObjectives, quarterlyKeyResults)`
- `getQuarterlyProgress()` → `getQuarterlyProgress(quarterlyObjectives, quarterlyKeyResults)`
- `getProgressEvolution(days)` → `getProgressEvolution(quarterlyKeyResults, days)`
- `getTrendAnalysis()` → `getTrendAnalysis(quarterlyKeyResults)`
- `getDetailedStats()` → `getDetailedStats(ambitions, keyResults, okrs, actions, quarterlyObjectives, quarterlyKeyResults)`
- `calculateQuarterlyKRHealth(kr)` → `calculateQuarterlyKRHealth(kr, actions)`
- `getKRHealthOverview()` → `getKRHealthOverview(quarterlyKeyResults, actions)`
- `getRiskAlerts()` → `getRiskAlerts(quarterlyKeyResults, actions)`

**Impact :** Les composants qui utilisent `analyticsService` devront passer les données en paramètres

---

### 2. `src/services/export.ts`
**Problème :** Utilisait `storageService` pour récupérer les données à exporter

**Solution :** Créé un stub temporaire qui retourne des données vides

```typescript
const storageService = {
  getAmbitions: () => [],
  getKeyResults: () => [],
  getOKRs: () => [],
  getActions: () => [],
  getQuarterlyObjectives: () => [],
  getQuarterlyKeyResults: () => [],
  getProgress: () => [],
  exportData: () => '{}',
  importData: (_data: string) => {},
};
```

**Impact :** Les exports PDF/Excel/JSON ne fonctionneront pas tant que le service n'est pas migré vers Supabase

**TODO :** Migrer ce service pour utiliser les données depuis Supabase

---

### 3. `src/services/import.ts`
**Problème :** Utilisait `storageService` pour importer les données CSV

**Solution :** Créé un stub temporaire

```typescript
const storageService = {
  addAmbition: (_ambition: Ambition) => {},
  addQuarterlyObjective: (_objective: QuarterlyObjective) => {},
  addQuarterlyKeyResult: (_keyResult: QuarterlyKeyResult) => {},
  addAction: (_action: Action) => {},
};
```

**Impact :** L'import CSV ne fonctionnera pas tant que le service n'est pas migré vers Supabase

**TODO :** Migrer ce service pour utiliser les services Supabase

---

### 4. `src/services/db/dataService.ts`
**Problème :** Service hybride qui utilisait `storageService` comme fallback

**Solution :** Créé un stub temporaire avec toutes les méthodes nécessaires

```typescript
const storageService = {
  getAmbitions: () => [] as Ambition[],
  getKeyResults: () => [] as KeyResult[],
  getQuarterlyObjectives: () => [] as QuarterlyObjective[],
  getQuarterlyKeyResults: () => [] as QuarterlyKeyResult[],
  getActions: () => [] as Action[],
  getProgress: () => [] as Progress[],
  addAmbition: (_ambition: Ambition) => {},
  updateAmbition: (_id: string, _updates: Partial<Ambition>) => {},
  deleteAmbition: (_id: string) => {},
  // ... autres méthodes
};
```

**Impact :** Le fallback localStorage ne fonctionne plus, seul Supabase est utilisé

**TODO :** Supprimer complètement le fallback localStorage et utiliser uniquement Supabase

---

### 5. `src/services/share.ts`
**Problème :** Utilisait `storageService` pour récupérer les données à partager

**Solution :** Créé un stub temporaire

```typescript
const storageService = {
  getQuarterlyObjectives: () => [] as QuarterlyObjective[],
  getQuarterlyKeyResults: () => [] as QuarterlyKeyResult[],
  getActions: () => [] as Action[],
};
```

**Impact :** Le partage ne fonctionnera pas tant que le service n'est pas migré vers Supabase

**TODO :** Migrer ce service pour utiliser les services Supabase

---

### 6. `src/utils/debugDataSync.ts`
**Problème :** Utilitaires de débogage qui utilisaient `storageService`

**Solution :** Créé un stub temporaire

```typescript
const storageService = {
  getAmbitions: () => [],
  getKeyResults: () => [],
  getOKRs: () => [],
  getActions: () => [],
  getQuarterlyObjectives: () => [],
  getQuarterlyKeyResults: () => [],
  getProgress: () => [],
  exportData: () => '{}',
  clear: () => {},
};
```

**Impact :** Les utilitaires de débogage ne fonctionnent plus

**TODO :** Créer de nouveaux utilitaires de débogage pour Supabase

---

### 7. `src/pages/legal/gdpr.tsx`
**Problème :** Page RGPD qui utilisait `storageService.clear()` pour supprimer les données

**Solution :** Créé un stub temporaire

```typescript
const storageService = {
  clear: () => {},
};
```

**Impact :** La suppression des données depuis la page RGPD ne fonctionne pas

**TODO :** Utiliser les services Supabase pour supprimer les données

---

### 8. `src/components/ui/CommentList.tsx`
**Problème :** Composant qui utilisait `storageService` pour gérer les commentaires

**Solution :** Créé un stub temporaire

```typescript
const storageService = {
  getCommentsFor: (_entityId: string, _entityType: Comment['objectiveType']) => [] as Comment[],
  addComment: (_comment: Comment) => {},
  deleteComment: (_id: string) => {},
};
```

**Impact :** Les commentaires ne fonctionnent pas

**TODO :** Utiliser le service `CommentsService` de Supabase

---

## 📊 Résumé

### Fichiers modifiés : 8
- ✅ `src/services/analytics.ts` - Méthodes modifiées pour accepter les données en paramètres
- ✅ `src/services/export.ts` - Stub temporaire
- ✅ `src/services/import.ts` - Stub temporaire
- ✅ `src/services/db/dataService.ts` - Stub temporaire
- ✅ `src/services/share.ts` - Stub temporaire
- ✅ `src/utils/debugDataSync.ts` - Stub temporaire
- ✅ `src/pages/legal/gdpr.tsx` - Stub temporaire
- ✅ `src/components/ui/CommentList.tsx` - Stub temporaire

### Fonctionnalités temporairement désactivées
- ❌ Export PDF/Excel/JSON
- ❌ Import CSV
- ❌ Partage d'objectifs
- ❌ Commentaires
- ❌ Suppression des données RGPD
- ❌ Utilitaires de débogage

---

## 🚀 Prochaines étapes

### Priorité 1 : Tester `/test-ui`
Valider que l'application se build et fonctionne correctement avec React Query

### Priorité 2 : Migrer les composants UI
Remplacer les appels `useAppStore` par les hooks React Query dans les pages principales

### Priorité 3 : Migrer les services désactivés
Une fois les composants UI migrés, migrer les services suivants :
1. `export.ts` - Utiliser les hooks React Query pour récupérer les données
2. `import.ts` - Utiliser les services Supabase pour importer les données
3. `share.ts` - Utiliser le service `SharedObjectivesService`
4. `CommentList.tsx` - Utiliser le service `CommentsService`
5. `gdpr.tsx` - Utiliser les services Supabase pour supprimer les données

---

**Date :** 2025-10-31  
**Version :** OsKaR v2.0 (Supabase + React Query)  
**Auteur :** Augment Agent

